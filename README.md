<p align="center">
  <img src="http://imgur.com/NFw6Fwu.png"/>
</p>
<p align="center">
  <i>Do what you want, if you can.</i>
</p>

&nbsp;

# Imperium

**由於帝國複雜，文件偏長，建議你先從索引選擇自己想要知道的。**

&nbsp;

帝國是一個基於 PHP 權限管理類別，具有龐大的複雜性，**不應該將帝國用於小型網站（如論壇，購物系統）**

建立一個帝國，精心的規畫是不能少的。帝國針對資源有做特別的處理，

一般來說，權限管理**只管你能否執行什麼動作**，但在帝國之中，

**你可以選擇可否針對「特別物品」執行什麼動作**。

&nbsp;

# 特色

1. 動作請求紀錄

2. 明瞭的使用方法

3. 動作捷徑

4. 角色系統

5. 組織系統

6. 單個使用者可以擁有多個角色

7. 資源針對系統

&nbsp;

# 索引

1. 示範

2. 組織

  * 新增
  
  * 選擇

3. 角色

  * 新增
  
  * 選擇
  
  * 指派

4. 權限

  * 基礎於資源上

    * 組織

    * 角色
    
    * 種類
    
    * 編號
    
    * 儲存供稍後使用

  * 檢查
  
    * 可以嗎？
    
    * 不可以嗎？
  
  * 設置

    * 允許和禁止動作和萬用符號
  
    * 允許和禁止種類

    * 允許和禁止特定編號
    
    * 動作捷徑
    
    * 基於資源的設置範例

  * 取得
  
    * 允許和禁止的資源
    
    * 允許和禁止的權限
 
5. 「別當個雞掰人」公眾授權條款

6. 可參考文件 


&nbsp;

# 示範

現在的示範可能跟其他人的不太一樣，但是，當你習慣之後，

你就會發現其實更好上手。然而這個示範其實**只有展示 50% 不到**的功能。

```php
$imperium
/** 建立「網站」組織 */
->addOrg('網站')

/** 「網站」組織下新增「管理員」角色 */
->addRole('管理員')

/** 給予「管理員」一個「編輯」的權限 */
->allow('編輯')

/** 讓現在這個 使用者 成為「管理員」*/
->assign('管理員');


/** 然後判斷的時候就像這樣，詢問是否有權力執行 編輯 動作 */
if($imperium->can('編輯'))
{
    ... 程式 ...
}
```

&nbsp;

# 組織

組織在帝國中是極為重要的一環，組織名稱不可以重複，如果你用不到組織功能，你也可以選擇**不建立**組織。

&nbsp;

## 新增

透過 `addOrg()` 來建立一個組織，**請注意：當你建立組織之後，你接下來新增的角色都會所屬這個組織**。

```php
->addOrg('組織名稱')

/** 或者這個組織還有個父組織 */
->addOrg('組織名稱', '父組織名稱')
```

&nbsp;

## 選擇

若要避免接下來新增的角色都屬於這個組織，透過 `org()` 函式，來選擇其他組織，或是直接讓他們不屬於任何組織。

```php
->org('組織名稱')

/** 或是選擇不屬於任何組織 */
->org()
```

&nbsp;

# 角色

角色讓帝國能夠認清你具有什麼樣的權限。

&nbsp;

## 新增

透過 `addRole()` 新增一個角色，你也可以讓角色繼承另一個角色（也就是繼承權限），

當你**新增了一個角色之後**，**接下來所發生的事情都會指定到這個角色身上**，如果你不希望這樣，

請透過「選擇」來選擇別的角色或是不指定角色。

```php
->addRole('管理員')

/** 讓 管理員 繼承 版主的權限 */
->addRole('管理員', '版主')

/** 讓 訪客 和 使用者 繼承版主的權限 */
->addRole(['訪客', '使用者'], '版主')
```
 
&nbsp;

## 選擇

透過 `role()` 來選擇一個角色，接下來的動作都會有關這個角色，

也可以透過留空，來不選擇角色。

```php
->role('管理員')

/** 或是不選擇角色 */
->role()
```

&nbsp;

## 指派

透過 `assign()` 讓目前的使用者成為某個角色。

```php
->assign('管理員')

/** 或者如果有所屬組織 */
->org('單身俱樂部')
->assign('管理員')
```

&nbsp;

# 權限

當你只擁有角色是無用的，你必須給予他們權限，如此一來，才能真正的使整個帝國運轉。

&nbsp;

## 基礎於資源上

有些時候，你希望這些權限是基於資源上，什麼意思？

基本的權限**只針對你有沒有辦法做這個動作**，但是當你針對資源的時候，變成這樣：

「你有沒有辦法**對這個東西**執行**這個動作**？」

&nbsp;

然而，你今天可能想針對特定的角色，組織，例如：

> 版主**可以**編輯所有文章，但是不可以編輯管理員所發表的文章，

這個時候就需要設定兩種權限：

> 1. **可以**編輯文章。

> 2. **不可以**編輯屬於 管理員 所發表的 文章。 

這個時候你就可以透過「不可以」來覆寫「原本可以」的規則，

而第二個權限則是**符合**基於角色的資源條件。

&nbsp;

**該注意的是：每當你新增一次權限，你就必須再使用一次這個函式，否則你下次新增的權限會不基於資源條件。**

&nbsp;
  
### 組織

基於組織的資源條件，在新增權限之前先使用 `resOrg()`，

如果你接下來不指定特別的角色資源條件，那麼就會限制成「**無論誰，只要是這個組織所持有的資源**」，

```php
->resOrg('單身俱樂部')
```
  
&nbsp;

### 角色

基於角色的資源條件，在新增權限之前先使用 `resRole()`。

```php
->resRole('管理員')

/** 或者你想要指定單身俱樂部的所有管理員 */
->resOrg('單身俱樂部')
->resRole('管理員')
```

&nbsp;

### 種類

基於種類的資源條件，在新增權限之前先使用 `resType()`。

```php
->resType('文章')
```

&nbsp;

### 編號

基於編號的資源條件，在新增權限之前先使用 `resId()`。

```php
->resId(3)
```

&nbsp;

### 儲存供稍後使用

每當執行任何動作，都有可能導致你所設定的資源條件清空，

如果你要避免每次都重新設置的麻煩，你可以選擇儲存他們，

然後在要使用的時候都讀取一次設定，透過 `resSave()` 儲存，`resLoad()` 讀取。

```php
$rule = $imperium->resOrg('單身俱樂部')
                 ->resRole('管理員')
                 ->resType('文章')
                 ->resSave();           // 儲存！

$question = $imperium->resLoad($Rule)   // 讀取！
                     ->can('移除');

/** 可以移除 單身俱樂部 管理員 所發表的 文章 嗎？*/
if($question)
{
    ... 程式 ...
}
```

&nbsp;

## 檢查

用以檢查是否有權限去做某件事情。

**請注意：每當 `can()` 或是 `cannot()` 執行過後，會重設資源條件。**

&nbsp;

### 可以嗎？

透過 `can()` 來詢問**是否有權利**去做某件事情。

或者是透過 `can(動作, 資源種類, 資源編號)` 來省去一直設置 `resType()`、`resId()` 的麻煩。

```php
->can('移除')
/** 兩個條件必須都符合 */
->can(['移除', '編輯'])
/** 或者你也可以：是否有權限「移除」「編號3」的「文章」*/
->can('移除', '文章', 3)

/** 像這樣：這個使用者有編輯權限嗎？ */
if($imperium->can('編輯'))
{
    ... 程式 ...
}
```

&nbsp;

### 不可以嗎？

`can()` 的相反，透過 `cannot()` 來詢問是否**沒有權利**去做某件事情。

或者是透過 `cannot(動作, 資源種類, 資源編號)` 來省去一直設置 `resType()`、`resId()` 的麻煩。

```php
->cannot('新增')
/** 兩個條件必須都符合 */
->cannot(['移除', '編輯'])
/** 或者你也可以：是否不可以「移除」「編號3」的「文章」*/
->cannot('移除', '文章', 3)

/** 像這樣：這個使用者是不是「沒有新增權限」？ */
if($imperium->cannot('新增'))
{
    ... 程式 ...
}
```

&nbsp;

### 與資源條件搭配時

你可以透過先前的 `resOrg()`、`resRole()`、`resId()`、`resType()` 來搭配 `can()` 和 `cannot()`。

如果你因為每次都要設定資源條件而感到厭倦，請嘗試上放的方式「儲存資源條件供稍後使用」。

```php
/** 是否有權限「移除」任何「單身俱樂部」 所擁有的資源？ */
if($imperium->resOrg('單身俱樂部')
            ->can('移除'))

/** 是否有權限「編輯」任何「文章」？ */
if($imperium->resType('文章')
             ->can('編輯'))

/** 是否有權限「觀看」任何「管理員」所發表的「文章」？ */
if($imperium->resRole('管理員')
            ->resType('文章')
            ->can('編輯'))

/** 是否有權限「編輯」「編號3」的「文章」？ */
if($imperium->resType('文章')
            ->resId(5)
            ->can('編輯'))
```

## 設置

&nbsp;

### 允許和禁止動作和萬用符號

透過 `allow()` 來允許，`deny()` 來拒絕你目前選擇的角色，做什麼事情，

將動作更換成 `%` 則是代表所有的事情。

```php
->allow('刪除')
->can('刪除')    // True

->deny('刪除')
->can('刪除')    // False
->cannot('刪除') // True

->deny('%')
->can('編輯')    // False
```

&nbsp;

### 動作捷徑

當你有許多動作，你可以試著透過 `alias()` 將他們融為一個動作，像這樣：

```php
->alias('管理', ['新增', '編輯', '移除'])

->allow('管理')

->can('新增')           // True
->can(['編輯', '移除']) // True
```

&nbsp;

### 基於資源的設置範例

如果你想要指定特別項目，種類，組織，角色，請使用上方曾經提到過的 `res` 系列：

```php
/** 可以「移除」所有「文章」*/
->resType('文章')->allow('移除')

/** 禁止「編輯」任何屬於「管理員」的資源 */
->resRole('管理員')->deny('編輯')
```

&nbsp;

## 取得

&nbsp;

### 允許和禁止的資源

&nbsp;

### 允許和禁止的權限

&nbsp;

# 「別當個雞掰人」公眾授權條款

> 版本一，2009 年 12 月

> 版權所有 (C) 2009 Philip Sturgeon <me@philsturgeon.uk>
 
任何人都有權限複製與發佈本認證的原始或修改過的版本。若要修改本認證，須修改認證名稱。

> 「別當個雞掰人」公眾授權條款
>  複製、散布以及重製的條款和條件

 1. 只要別當個雞掰人，你可以對原作品做任何事情。

     成為雞掰人的定義包括下列 - 但不僅限於：
     
	 1a. 徹底侵權 — 別只是複製這個作品然後改個名字而已。  
	 1b. 販售未經更改的原始碼，這樣**真的**很雞掰。  
	 1c. 修改原始碼並偷偷增加一些有害的內容。這樣會使你成為**真正的**雞掰人。  

 2. 如果你透過修改，或是為此提供相關服務，而或支持原作者而致富，請分享這份愛。只有雞掰人才會只幫自己，而不協助原始作品。
 
 3. 此份原始碼並不具有保固。當你使用他人原始碼發生錯誤，而指責他人時，會讓你看起來**夭壽**雞掰。自己學會修正問題。而一個不雞掰的人應該會送出這個修正給原作者。

&nbsp;

# 可參考文件

[Role Based Access Control in PHP](http://www.sitepoint.com/role-based-access-control-in-php/)

[efficiently/authority-controller](https://github.com/efficiently/authority-controller)

[BeatSwitch/lock](https://github.com/BeatSwitch/lock)

[OWASP/rbac](https://github.com/OWASP/rbac)

[machuga/authority](https://github.com/machuga/authority)
